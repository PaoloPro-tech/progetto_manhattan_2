<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progetto Manhattan | Strategic AI</title>
    <!-- Tailwind CSS (Stile) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js (Logica Frontend semplice) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Chart.js (Grafici belli) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        /* Glassmorphism Cards */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .gradient-text {
            background: linear-gradient(to right, #38bdf8, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* Loading Spinner */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #38bdf8;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col" x-data="app()">

    <!-- HEADER -->
    <header class="w-full glass sticky top-0 z-50 px-8 py-4 flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-xl shadow-blue-500/50 shadow-lg">‚ò¢Ô∏è</div>
            <div>
                <h1 class="text-xl font-bold tracking-tight">PROGETTO <span class="gradient-text">MANHATTAN</span></h1>
                <p class="text-xs text-slate-400">Akkodis Strategic Intelligence</p>
            </div>
        </div>
        <div class="flex gap-4">
            <input type="file" id="csvUpload" class="hidden" @change="uploadCsv">
            <button onclick="document.getElementById('csvUpload').click()" class="px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 rounded-lg transition border border-slate-600 flex items-center gap-2">
                üìÇ Upload Dati
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-8 grid grid-cols-12 gap-8 max-w-[1600px] mx-auto w-full">
        
        <!-- SIDEBAR CONTROLS -->
        <aside class="col-span-12 lg:col-span-3 space-y-6">
            <div class="glass p-6 space-y-4">
                <h2 class="text-sm uppercase tracking-wider text-slate-500 font-bold">Configurazione</h2>
                
                <div>
                    <label class="block text-sm mb-2">Seleziona Cliente</label>
                    <select x-model="selectedClient" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none">
                        <template x-for="client in clients" :key="client">
                            <option :value="client" x-text="client"></option>
                        </template>
                    </select>
                </div>

                <div>
                    <label class="block text-sm mb-2">Settore</label>
                    <div class="w-full bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-slate-400" x-text="getSector(selectedClient)"></div>
                </div>

                <button @click="runAnalysis" :disabled="loading" class="w-full py-3 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed rounded-lg font-bold shadow-lg shadow-blue-900/50 transition flex justify-center items-center gap-2">
                    <span x-show="loading" class="loader"></span>
                    <span x-show="!loading">LANCIA ANALISI üöÄ</span>
                </button>
            </div>

            <!-- STATUS LOG -->
            <div class="glass p-6 h-64 overflow-y-auto font-mono text-xs space-y-2" id="logs">
                <div class="text-slate-500 border-b border-slate-700 pb-2 mb-2">System Logs</div>
                <template x-for="log in logs">
                    <div :class="log.type === 'error' ? 'text-red-400' : 'text-green-400'">
                        <span class="opacity-50" x-text="log.time"></span> > <span x-text="log.msg"></span>
                    </div>
                </template>
            </div>
        </aside>

        <!-- DASHBOARD AREA -->
        <div class="col-span-12 lg:col-span-9 space-y-6" x-show="analysisDone" x-transition.opacity>
            
            <!-- KPI CARDS -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-6 border-l-4 border-blue-500">
                    <p class="text-sm text-slate-400">Previsione FY2026</p>
                    <h3 class="text-3xl font-bold mt-1" x-text="formatCurrency(metrics.previsione_prossimo_anno)"></h3>
                </div>
                <div class="glass p-6 border-l-4 border-purple-500">
                    <p class="text-sm text-slate-400">Crescita Stimata</p>
                    <h3 class="text-3xl font-bold mt-1 flex items-center gap-2">
                        <span x-text="metrics.crescita_percentuale + '%'"></span>
                        <span x-show="metrics.crescita_percentuale > 0" class="text-green-400 text-lg">‚ñ≤</span>
                        <span x-show="metrics.crescita_percentuale <= 0" class="text-red-400 text-lg">‚ñº</span>
                    </h3>
                </div>
                <div class="glass p-6 border-l-4 border-emerald-500">
                    <p class="text-sm text-slate-400">Affidabilit√† Modello</p>
                    <h3 class="text-3xl font-bold mt-1" x-text="metrics.confidenza_min > 0 ? 'ALTA' : 'MEDIA'"></h3>
                </div>
            </div>

            <!-- CHART AREA -->
            <div class="glass p-6">
                <h3 class="font-bold mb-4 flex justify-between items-center">
                    <span>üìâ Proiezione Finanziaria (Prophet Engine)</span>
                    <span class="text-xs px-2 py-1 bg-blue-900 text-blue-200 rounded">AI Generated</span>
                </h3>
                <div class="relative h-72 w-full">
                    <canvas id="forecastChart"></canvas>
                </div>
            </div>

            <!-- REPORT & CHAT GRID -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- AI REPORT -->
                <div class="glass p-6 flex flex-col h-[600px]">
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-700">
                        <h3 class="font-bold">üëî Report Strategico</h3>
                        <button @click="downloadPdf" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition">üì• Scarica PDF</button>
                    </div>
                    <div class="flex-1 overflow-y-auto prose prose-invert prose-sm pr-2" x-html="parseMarkdown(reportText)"></div>
                </div>

                <!-- CHAT -->
                <div class="glass p-6 flex flex-col h-[600px]">
                    <div class="mb-4 pb-4 border-b border-slate-700">
                        <h3 class="font-bold">üí¨ Chat con il Direttore</h3>
                    </div>
                    
                    <!-- Messages -->
                    <div class="flex-1 overflow-y-auto space-y-4 mb-4 pr-2" id="chatContainer">
                        <template x-for="msg in chatHistory">
                            <div :class="msg.role === 'user' ? 'text-right' : 'text-left'">
                                <div :class="msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-200'" 
                                     class="inline-block px-4 py-2 rounded-lg max-w-[85%] text-sm shadow">
                                    <span x-text="msg.content"></span>
                                </div>
                            </div>
                        </template>
                        <div x-show="chatLoading" class="text-left">
                            <div class="inline-block px-4 py-2 bg-slate-700 rounded-lg">
                                <span class="loader w-4 h-4 inline-block"></span> Scrivendo...
                            </div>
                        </div>
                    </div>

                    <!-- Input -->
                    <div class="flex gap-2">
                        <input type="text" x-model="chatInput" @keydown.enter="sendMessage" 
                               placeholder="Chiedi dettagli sulla strategia..." 
                               class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <button @click="sendMessage" class="bg-blue-600 hover:bg-blue-500 px-4 rounded-lg">‚û§</button>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <!-- LOGIC SCRIPT -->
    <script>
        const API_URL = "http://127.0.0.1:8000";

        function app() {
            return {
                clients: [],
                selectedClient: '',
                loading: false,
                analysisDone: false,
                metrics: {},
                reportText: '',
                logs: [],
                chatHistory: [],
                chatInput: '',
                chatLoading: false,
                chartInstance: null,

                async init() {
                    this.log("Inizializzazione Dashboard...");
                    try {
                        const res = await fetch(`${API_URL}/clients`);
                        const data = await res.json();
                        this.clients = data.clients;
                        if(this.clients.length > 0) this.selectedClient = this.clients[0];
                        this.log("Clienti caricati: " + this.clients.length);
                    } catch (e) {
                        this.log("Errore connessione API: " + e, 'error');
                    }
                },

                getSector(name) {
                    const map = {"Leonardo": "Aerospace", "Stellantis": "Automotive", "Ferrari": "Luxury", "Gucci": "Fashion"};
                    return map[name] || "General Industry";
                },

                log(msg, type='info') {
                    const time = new Date().toLocaleTimeString();
                    this.logs.unshift({time, msg, type});
                },

                formatCurrency(val) {
                    return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val);
                },

                parseMarkdown(text) {
                    return marked.parse(text || '');
                },

                async uploadCsv(e) {
                    const file = e.target.files[0];
                    if(!file) return;
                    const formData = new FormData();
                    formData.append('file', file);
                    this.log("Upload in corso...");
                    try {
                        const res = await fetch(`${API_URL}/upload-data`, { method: 'POST', body: formData });
                        if(res.ok) this.log("Upload Completato con successo!");
                        else this.log("Errore Upload", 'error');
                    } catch(e) { this.log("Errore: " + e, 'error'); }
                },

                async runAnalysis() {
                    this.loading = true;
                    this.analysisDone = false;
                    this.chatHistory = []; // Reset chat
                    this.log(`Avvio analisi per ${this.selectedClient}...`);

                    try {
                        // 1. Forecast
                        const forecastRes = await fetch(`${API_URL}/forecast`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({client_name: this.selectedClient, months: 12})
                        });
                        const forecastData = await forecastRes.json();
                        this.metrics = forecastData.metrics;
                        this.renderChart(forecastData.forecast_data);
                        this.log("Forecast quantitativo completato.");

                        // 2. Agents
                        this.log("Attivazione Agenti AI...");
                        const agentRes = await fetch(`${API_URL}/agent/analyze`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                client_name: this.selectedClient,
                                sector: this.getSector(this.selectedClient),
                                metrics: this.metrics
                            })
                        });
                        const agentData = await agentRes.json();
                        this.reportText = agentData.final_report;
                        
                        this.analysisDone = true;
                        this.log("Analisi Strategica Completata!");

                    } catch (e) {
                        this.log("Errore durante l'analisi: " + e, 'error');
                    } finally {
                        this.loading = false;
                    }
                },

                async sendMessage() {
                    if(!this.chatInput.trim()) return;
                    const question = this.chatInput;
                    this.chatHistory.push({role: 'user', content: question});
                    this.chatInput = '';
                    this.chatLoading = true;
                    this.scrollToBottom();

                    try {
                        const res = await fetch(`${API_URL}/agent/chat`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                question: question,
                                context_report: this.reportText
                            })
                        });
                        const data = await res.json();
                        this.chatHistory.push({role: 'bot', content: data.answer});
                        this.scrollToBottom();
                    } catch(e) {
                        this.chatHistory.push({role: 'bot', content: "Errore di connessione..."});
                    } finally {
                        this.chatLoading = false;
                    }
                },

                async downloadPdf() {
                    this.log("Generazione PDF in corso...");
                    try {
                        const res = await fetch(`${API_URL}/report/pdf`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                client_name: this.selectedClient,
                                sector: this.getSector(this.selectedClient),
                                report_text: this.reportText
                            })
                        });
                        if(res.ok) {
                            const blob = await res.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `Report_${this.selectedClient}.pdf`;
                            a.click();
                            this.log("PDF scaricato.");
                        }
                    } catch(e) { this.log("Errore PDF: " + e, 'error'); }
                },

                scrollToBottom() {
                    setTimeout(() => {
                        const el = document.getElementById('chatContainer');
                        el.scrollTop = el.scrollHeight;
                    }, 100);
                },

                renderChart(data) {
                                    const ctx = document.getElementById('forecastChart').getContext('2d');
                                    
                                    // Prepariamo i dati
                                    const labels = data.map(d => new Date(d.ds).toLocaleDateString('it-IT', {month:'short', year:'2-digit'}));
                                    const yhat = data.map(d => d.yhat);
                                    const upper = data.map(d => d.yhat_upper);
                                    const lower = data.map(d => d.yhat_lower);
                                    
                                    if(this.chartInstance) this.chartInstance.destroy();

                                    this.chartInstance = new Chart(ctx, {
                                        type: 'line',
                                        data: {
                                            labels: labels,
                                            datasets: [
                                                // 1. Linea Principale (Previsione)
                                                {
                                                    label: 'Previsione (‚Ç¨)',
                                                    data: yhat,
                                                    borderColor: '#38bdf8', // Azzurro Ciano
                                                    backgroundColor: '#38bdf8',
                                                    borderWidth: 2,
                                                    tension: 0.3, // Meno curvo, pi√π preciso
                                                    pointRadius: 0,
                                                    pointHoverRadius: 6,
                                                    zIndex: 10
                                                },
                                                // 2. Limite Superiore (Invisibile, serve per il riempimento)
                                                {
                                                    label: 'Max',
                                                    data: upper,
                                                    borderColor: 'transparent',
                                                    pointRadius: 0,
                                                    fill: false,
                                                    tension: 0.3
                                                },
                                                // 3. Limite Inferiore (Riempie fino al Superiore)
                                                {
                                                    label: 'Intervallo di Confidenza',
                                                    data: lower,
                                                    borderColor: 'transparent',
                                                    backgroundColor: 'rgba(56, 189, 248, 0.15)', // Alone Azzurro Trasparente
                                                    pointRadius: 0,
                                                    fill: '-1', // Riempie fino al dataset precedente (Upper)
                                                    tension: 0.3
                                                }
                                            ]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            interaction: {
                                                mode: 'index',
                                                intersect: false,
                                            },
                                            plugins: { 
                                                legend: { display: false },
                                                tooltip: {
                                                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                                    titleColor: '#e2e8f0',
                                                    bodyColor: '#38bdf8',
                                                    borderColor: 'rgba(255,255,255,0.1)',
                                                    borderWidth: 1,
                                                    callbacks: {
                                                        label: function(context) {
                                                            if(context.datasetIndex !== 0) return null; // Mostra tooltip solo per la linea principale
                                                            return ' ‚Ç¨ ' + new Intl.NumberFormat('it-IT').format(context.raw);
                                                        }
                                                    }
                                                }
                                            },
                                            scales: {
                                                y: { 
                                                    grid: { color: 'rgba(255,255,255,0.05)' }, 
                                                    ticks: { color: '#64748b', callback: (value) => '‚Ç¨ ' + (value/1000) + 'k' } 
                                                },
                                                x: { 
                                                    grid: { display: false }, 
                                                    ticks: { color: '#64748b' } 
                                                }
                                            }
                                        }
                                    });
                                }
            }
        }
    </script>
</body>
</html>